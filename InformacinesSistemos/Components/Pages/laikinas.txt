
@page "/checkout"
@rendermode InteractiveServer

@using InformacinesSistemos.Models
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Authorization

@inject InformacinesSistemos.Services.ICartService CartService
@inject InformacinesSistemos.Services.IBankPaymentService BankPaymentService
@inject InformacinesSistemos.Services.IUserLookupService UserLookup
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav

<PageTitle>Apmokėjimas</PageTitle>

<h2>Užsakymo apmokėjimas</h2>

@if (!CartService.Items.Any())
{
    <p>Jūsų krepšelis tuščias. Pirmiausia pridėkite žaidimų į krepšelį.</p>
    <button class="primary-btn" @onclick="GoToGames">Peržiūrėti žaidimus</button>
}
else if (!isAuthenticated)
{
    <p>Norėdami atlikti užsakymą, turite prisijungti.</p>
}
else if (isCompleted)
{
    <div class="checkout-success">
        <h3>Užsakymas sėkmingai pateiktas</h3>
        <p>
            Jūsų užsakymas Nr. <strong>@orderNumber</strong> priimtas.
            Patvirtinimas išsiųstas el. paštu <strong>@currentUserEmail</strong>.
        </p>
        <button class="primary-btn" @onclick="GoToMyGames">Peržiūrėti mano žaidimus</button>
    </div>
}
else
{
    <div class="checkout-layout">
        <EditForm Model="order" OnValidSubmit="ConfirmOrder">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="checkout-form">
                <h3>Pirkėjo duomenys</h3>

                <label>
                    Vardas, pavardė
                    <InputText @bind-Value="order.FullName" />
                </label>

                <label>
                    El. paštas
                    <InputText @bind-Value="order.Email" />
                </label>

                <label>
                    Telefono numeris
                    <InputText @bind-Value="order.Phone" />
                </label>

                <h3>Pristatymas / sąskaitos adresas</h3>

                <label>
                    Gatvė, namo / buto nr.
                    <InputText @bind-Value="order.AddressLine" />
                </label>

                <label>
                    Miestas
                    <InputText @bind-Value="order.City" />
                </label>

                <label>
                    Pašto kodas
                    <InputText @bind-Value="order.PostCode" />
                </label>

                <label>
                    Papildoma informacija (nebūtina)
                    <InputTextArea @bind-Value="order.Notes" rows="3" />
                </label>

                <h3>Mokėjimo būdas</h3>
                <InputRadioGroup @bind-Value="order.PaymentMethod" class="payment-group">
                    <label><InputRadio Value="@PaymentKortele" /> Banko kortele</label>
                    <label><InputRadio Value="@PaymentElBank" /> Elektroninė bankininkystė</label>
                    <label><InputRadio Value="@PaymentPayPal" /> PayPal</label>
                </InputRadioGroup>

                @if (order.PaymentMethod == PaymentKortele)
                {
                    <div class="card-payment">
                        @if (!showCardForm)
                        {
                            <button type="button" class="primary-btn" @onclick="() => showCardForm = true">Mokėti kortele</button>
                        }
                        else
                        {
                            <h4>Kortelės duomenys</h4>

                            <label>
                                Kortelės ID
                                <InputNumber @bind-Value="card.KortelesID" />
                            </label>
                            <label>
                                Vardas
                                <InputText @bind-Value="card.Vardas" />
                            </label>
                            <label>
                                Pavardė
                                <InputText @bind-Value="card.Pavarde" />
                            </label>
                            <label>
                                PIN kodas (4 sk.)
                                <InputText @bind-Value="card.PinKodas" type="password" />
                            </label>

                            @if (isProcessing) { <p class="info">Vykdomas mokėjimas, palaukite...</p> }
                            @if (!string.IsNullOrEmpty(paymentMessage)) { <p class="@paymentStatusClass">@paymentMessage</p> }

                            <div class="form-actions">
                                <button type="button" class="outline-btn" @onclick="() => showCardForm = false" disabled="@isProcessing">Atšaukti</button>
                                <button type="button" class="primary-btn" @onclick="PayWithCard" disabled="@isProcessing">
                                    @(isProcessing ? "Vykdoma..." : "Vykdyti mokėjimą")
                                </button>
                            </div>
                        }
                    </div>
                }

                <div class="form-actions">
                    <button type="button" class="outline-btn" @onclick="GoBack">Grįžti į krepšelį</button>
                    @if (order.PaymentMethod != PaymentKortele)
                    {
                        <button type="submit" class="primary-btn">Patvirtinti užsakymą</button>
                    }
                </div>
            </div>
        </EditForm>

        <div class="checkout-summary">
            <h3>Užsakymo suvestinė</h3>
            <ul class="summary-items">
                @foreach (var item in CartService.Items)
                {
                    var game = item.Zaidimas;
                    <li>
                        <div class="si-main">
                            <span>@(game?.Aprasymas ?? "Žaidimas")</span>
                            <span>@item.Quantity x @((game?.Kaina ?? 0).ToString("0.00")) €</span>
                        </div>
                    </li>
                }
            </ul>
            <div class="summary-line"><span>Tarpinė suma</span><span>@Subtotal.ToString("0.00") €</span></div>
            <div class="summary-line"><span>Pristatymas</span><span>@Shipping.ToString("0.00") €</span></div>
            <div class="summary-total"><span>Iš viso</span><span>@Total.ToString("0.00") €</span></div>
        </div>
    </div>
}

@code {
    private const string PaymentKortele = "Kortele";
    private const string PaymentElBank = "ElBankininkyste";
    private const string PaymentPayPal = "PayPal";

    private bool isAuthenticated;
    private string? currentUserEmail;

    private OrderForm order = new();
    private CardPaymentForm card = new();

    private bool showCardForm = false;
    private bool isCompleted = false;
    private string orderNumber = string.Empty;
    private bool isProcessing = false;

    private string paymentMessage = string.Empty;
    private string paymentStatusClass = string.Empty;

    private double Subtotal => CartService.GetTotal();
    private double Shipping => CartService.Items.Any() ? 2.99 : 0;
    private double Total => Subtotal + Shipping;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isAuthenticated = user.Identity?.IsAuthenticated ?? false;
        currentUserEmail = user.Identity?.Name;
        if (!string.IsNullOrWhiteSpace(currentUserEmail))
            order.Email = currentUserEmail;

        order.PaymentMethod = PaymentKortele;
    }

    private void GoBack() => Nav.NavigateTo("/cart");
    private void GoToGames() => Nav.NavigateTo("/games");
    private void GoToMyGames() => Nav.NavigateTo("/mygames");

    private async Task ConfirmOrder()
    {
        orderNumber = $"GS-{DateTime.Now:yyyyMMddHHmmss}";
        isCompleted = true;
        CartService.Clear();
        await InvokeAsync(StateHasChanged);
    }

    private async Task PayWithCard()
    {
        if (isProcessing) return;
        isProcessing = true;
        paymentMessage = string.Empty;
        paymentStatusClass = string.Empty;
        StateHasChanged();

        try
        {
            if (string.IsNullOrWhiteSpace(card.Vardas) ||
                string.IsNullOrWhiteSpace(card.Pavarde) ||
                string.IsNullOrWhiteSpace(card.PinKodas) ||
                card.KortelesID <= 0)
            {
                paymentMessage = "Užpildykite visus kortelės duomenis.";
                paymentStatusClass = "error";
                return;
            }
            if (!System.Text.RegularExpressions.Regex.IsMatch(card.PinKodas, @"^\d{4}$"))
            {
                paymentMessage = "PIN kodas turi būti 4 skaitmenų.";
                paymentStatusClass = "error";
                return;
            }

            var amount = (decimal)Total;

            var chargeTask = BankPaymentService.TryChargeAsync(card, amount);
            var timeoutTask = Task.Delay(TimeSpan.FromSeconds(10));
            var completed = await Task.WhenAny(chargeTask, timeoutTask);
            if (completed == timeoutTask)
            {
                paymentMessage = "Mokėjimas vykdomas ilgiau nei įprastai. Patikrinkite užsakymų istoriją vėliau.";
                paymentStatusClass = "info";
                return;
            }
            var (ok, bankMsg) = await chargeTask;
            if (!ok)
            {
                paymentMessage = string.IsNullOrEmpty(bankMsg) ? "Nesėkmingas mokėjimas." : bankMsg;
                paymentStatusClass = "error";
                return;
            }

            // Vartotojo AK pagal el. paštą (privalomas šiame variante)
            if (string.IsNullOrWhiteSpace(currentUserEmail))
            {
                paymentMessage = "Nepavyko nustatyti naudotojo el. pašto. Prisijunkite iš naujo.";
                paymentStatusClass = "error";
                return;
            }
            var userAk = await UserLookup.GetAsmensKodasByEmailAsync(currentUserEmail!);
            if (userAk == null)
            {
                paymentMessage = "Naudotojas sistemoje nerastas (asmens kodas). Negalima sukurti siuntimo.";
                paymentStatusClass = "error";
                return;
            }

            var shippingRecord = new ShippingRecord
            {
                Adresas = $"{order.AddressLine}, {order.City} {order.PostCode}".Trim(),
                SiuntimoKaina = (decimal)Shipping,
                Busena = "Paruoštas",
                IsSiuntimoData = DateOnly.FromDateTime(DateTime.Today),
                FkNaudotojasAsmensKodas = userAk, // privalomas šiam variantui
                FkApmokejimasSekaltosId = card.KortelesID,
                FkUzsakymasSuUzsakymoId = null
            };

            var insertTask = BankPaymentService.InsertShippingAsync(shippingRecord);
            completed = await Task.WhenAny(insertTask, timeoutTask);
            if (completed != timeoutTask)
            {
                var insertedId = await insertTask;
            }

            orderNumber = $"GS-{DateTime.Now:yyyyMMddHHmmss}";
            isCompleted = true;
            paymentMessage = "Sėkmingai įvykdytas mokėjimas.";
            paymentStatusClass = "ok";
            CartService.Clear();
        }
        catch (Exception ex)
        {
            paymentMessage = $"Nesėkmingas mokėjimas: vidinė klaida ({ex.Message}).";
            paymentStatusClass = "error";
        }
        finally
        {
            isProcessing = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private class OrderForm
    {
        public string FullName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Phone { get; set; } = string.Empty;
        public string AddressLine { get; set; } = string.Empty;
        public string City { get; set; } = string.Empty;
        public string PostCode { get; set; } = string.Empty;
        public string Notes { get; set; } = string.Empty;
        public string PaymentMethod { get; set; } = string.Empty;
    }
}
