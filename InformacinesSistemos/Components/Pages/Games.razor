@page "/games"
@rendermode InteractiveServer

@using InformacinesSistemos.Models
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.AspNetCore.Components.Authorization

@inject InformacinesSistemos.Services.IGameService GameService
@inject InformacinesSistemos.Services.ICartService CartService
@inject NavigationManager Nav

<PageTitle>Žaidimai</PageTitle>

<h2>Žaidimų katalogas</h2>

<div class="games-filters">
    <input placeholder="Paieška pagal pavadinimą, kūrėją ar žanrą"
           @oninput="OnSearchChange" />

    <select @onchange="OnTypeChange" value="@selectedType">
        <option value="">Visi tipai</option>
        <option value="pc">Kompiuteriniai žaidimai</option>
        <option value="board">Stalo žaidimai</option>
    </select>

    <select @onchange="OnSaleTypeChange" value="@selectedSaleType">
        <option value="">Pardavimas ir nuoma</option>
        <option value="Pardavimas">Tik parduodami</option>
        <option value="Nuoma">Tik nuomojami</option>
    </select>
</div>

@if (showNotification)
{
    <div class="notification @notificationType">
        @notificationMessage
    </div>
}

@if (filteredGames is null)
{
    <p>Kraunama...</p>
}
else if (!filteredGames.Any())
{
    <p>Nerasta žaidimų pagal pasirinktus filtrus.</p>
}
else
{
    <div class="games-grid">
        @foreach (var g in filteredGames)
        {
            <div class="game-card">
                <div class="game-header">
                    <span class="game-type">@GetTypeLabel(g)</span>
                    <span class="game-price">
                        @g.Kaina.ToString("0.00") €
                        @if (g.PardavimoTipas == "Nuoma")
                        {
                            @: / mėn. (nuoma)
                        }
                        else
                        {
                            @: (pardavimas)
                        }
                    </span>
                </div>

                <h5>@g.Aprasymas</h5>

                <div class="game-meta">
                    <span>@g.Kurejas |</span>
                    <span>@g.ZaidejuSkaicius žaidėjai |</span>
                    <span>@($"Reitingas: {g.Reitingas:0.0}")</span>
                </div>

                <div class="game-actions">
                    <button class="outline-btn small-btn"
                            @onclick="@(() => Nav.NavigateTo($"/games/{g.ZaidimoId}"))">
                        Peržiūrėti
                    </button>

                    <AuthorizeView>
                        <Authorized>
                            <button class="primary-btn small-btn"
                                    @onclick="@(() => AddToCart(g))">
                                Į krepšelį
                            </button>
                        </Authorized>
                        <NotAuthorized>
                            <button class="outline-btn small-btn"
                                    @onclick="@(() => Nav.NavigateTo("/login"))">
                                Prisijunkite
                            </button>
                        </NotAuthorized>
                    </AuthorizeView>
                </div>
            </div>
        }
    </div>
}

@code {
    private List<Zaidimas>? allGames;
    private List<Zaidimas>? filteredGames;

    private string? selectedType;
    private string? selectedSaleType;
    private string searchText = string.Empty;

    private bool showNotification = false;
    private string notificationMessage = "";
    private string notificationType = ""; // success / info

    protected override async Task OnInitializedAsync()
    {
        await LoadGamesFromService();
        ApplyFilters();
    }

    protected override async Task OnParametersSetAsync()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("type", out var typeValues))
        {
            selectedType = typeValues.ToString();
        }

        if (allGames is null)
        {
            await LoadGamesFromService();
        }

        ApplyFilters();
    }

    private async Task LoadGamesFromService()
    {
        try
        {
            allGames = await GameService.GetAllAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine("ERROR while loading games: " + ex.Message);
            throw;
        }
    }

    private void ApplyFilters()
    {
        if (allGames is null)
            return;

        IEnumerable<Zaidimas> query = allGames;

        if (!string.IsNullOrWhiteSpace(selectedType))
        {
            query = selectedType switch
            {
                "pc" => query.Where(g => g.Kompiuterinis != null),
                "board" => query.Where(g => g.Stalo != null),
                _ => query
            };
        }

        if (!string.IsNullOrEmpty(selectedSaleType))
        {
            query = query.Where(g => g.PardavimoTipas == selectedSaleType);
        }

        if (!string.IsNullOrWhiteSpace(searchText))
        {
            var t = searchText.Trim();
            query = query.Where(g =>
                (g.Aprasymas?.Contains(t, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (g.Kurejas?.Contains(t, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (g.Zanras?.Pavadinimas?.Contains(t, StringComparison.OrdinalIgnoreCase) ?? false));
        }

        filteredGames = query.ToList();
    }

    private void OnSearchChange(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? string.Empty;
        ApplyFilters();
    }

    private void OnTypeChange(ChangeEventArgs e)
    {
        selectedType = e.Value?.ToString();
        ApplyFilters();
    }

    private void OnSaleTypeChange(ChangeEventArgs e)
    {
        selectedSaleType = e.Value?.ToString();
        ApplyFilters();
    }

    private void AddToCart(Zaidimas game)
    {
        CartService.Add(game, 1);
        ShowNotification($"„{game.Aprasymas}“ pridėtas į krepšelį!", "success");
    }

    private void ShowNotification(string message, string type = "success")
    {
        notificationMessage = message;
        notificationType = type;
        showNotification = true;

        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            showNotification = false;
            InvokeAsync(StateHasChanged);
        });
    }

    private static string GetTypeLabel(Zaidimas g)
        => g.Kompiuterinis != null ? "Kompiuterinis"
         : g.Stalo != null ? "Stalo"
         : "Kitas";
}