@page "/cart"
@rendermode InteractiveServer
@using InformacinesSistemos.Models
@inject InformacinesSistemos.Services.ICartService CartService
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>Krepšelis</PageTitle>

<h2>Krepšelis</h2>

@if (showNotification)
{
    <div class="simple-notification @notificationType">
        @notificationMessage
    </div>
}

@if (!CartService.Items.Any())
{
    <p>Jūsų krepšelis tuščias.</p>

    <button class="primary-btn" @onclick="GoToGames">
        Peržiūrėti žaidimus
    </button>
}
else
{
    <table class="cart-table">
        <thead>
            <tr>
                <th>Žaidimas</th>
                <th>Kūrėjas</th>
                <th>Kaina</th>
                <th>Kiekis</th>
                <th>Suma</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in CartService.Items)
            {
                var game = item.Zaidimas;
                <tr>
                    <td>@(game?.Aprasymas ?? "Žaidimas")</td>
                    <td>@(game?.Kurejas ?? "-")</td>
                    <td>@(game?.Kaina.ToString("0.00") ?? "0.00") €</td>
                    <td>@item.Quantity</td>
                    <td>@(((game?.Kaina ?? 0) * item.Quantity).ToString("0.00")) €</td>
                    <td>
                        <button class="link-btn remove-btn" @onclick="() => ConfirmRemoveAsync(item.ZaidimoId)">
                            Pašalinti
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div class="cart-summary">
        <span>Iš viso:</span>
        <span class="cart-total">@CartService.GetTotal().ToString("0.00") €</span>
    </div>

    <div class="cart-actions">
        <button class="outline-btn" @onclick="Clear">
            Išvalyti krepšelį
        </button>
        <button class="primary-btn" @onclick="GoToCheckout">
            Tęsti apmokėjimą
        </button>
    </div>
}

@code {
    private bool showNotification = false;
    private string notificationMessage = "";
    private string notificationType = ""; // "success" or "info" or "error"

    // Simpler: using browser confirm
    private async Task ConfirmRemoveAsync(int gameId)
    {
        // Native browser confirm
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "Ar tikrai norite pašalinti šį žaidimą iš krepšelio?");
        if (confirmed)
        {
            CartService.Remove(gameId);
            ShowNotification("Žaidimas sėkmingai pašalintas.", "success");
            // force UI update
            await InvokeAsync(StateHasChanged);
        }
        else
        {
            ShowNotification("Veiksmas atšauktas. Žaidimas nepašalintas.", "info");
        }
    }

    private void ShowNotification(string message, string type = "success")
    {
        notificationMessage = message;
        notificationType = type;
        showNotification = true;

        // auto-hide after 3 seconds
        _ = Task.Run(async () =>
        {
            await Task.Delay(3000);
            showNotification = false;
            await InvokeAsync(StateHasChanged);
        });
    }

    private void Clear()
    {
        CartService.Clear();
        ShowNotification("Krepšelis išvalytas.", "success");
    }

    private void GoToCheckout() => Nav.NavigateTo("/checkout");
    private void GoToGames() => Nav.NavigateTo("/games");
}