@page "/register"
@using System.ComponentModel.DataAnnotations
@using InformacinesSistemos.Services
@rendermode InteractiveServer

@inject InformacinesSistemos.Services.SimpleAuthenticationStateProvider AuthProvider
@inject NavigationManager Nav
@inject IRegistrationService RegistrationService

<PageTitle>Registracija</PageTitle>

<h2>Registracija</h2>

<p>
    Registracijos duomenys bus įrašomi į PostgreSQL duomenų bazę „ITInformaciniuSistemuPagrindai“.
    Po sėkmingos registracijos naudotojas automatiškai prisijungs kaip „Naudotojas“.
</p>

<EditForm Model="@model" OnValidSubmit="@HandleRegister">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="login-form">
        <label>
            Vardas
            <InputText @bind-Value="model.Vardas" />
        </label>
        <ValidationMessage For="@(() => model.Vardas)" />

        <label>
            Pavardė
            <InputText @bind-Value="model.Pavarde" />
        </label>
        <ValidationMessage For="@(() => model.Pavarde)" />

        <label>
            Asmens kodas
            <InputNumber @bind-Value="model.AsmensKodas" />
        </label>
        <ValidationMessage For="@(() => model.AsmensKodas)" />

        <label>
            Telefonas
            <InputText @bind-Value="model.Telefonas" />
        </label>
        <ValidationMessage For="@(() => model.Telefonas)" />

        <label>
            El. paštas
            <InputText @bind-Value="model.ElPastas" />
        </label>
        <ValidationMessage For="@(() => model.ElPastas)" />

        <label>
            Slaptažodis
            <InputText @bind-Value="model.Slaptazodis" type="password" />
        </label>
        <ValidationMessage For="@(() => model.Slaptazodis)" />

        <button class="primary-btn" type="submit" disabled="@isBusy">
            @(isBusy ? "Registruojama..." : "Registruotis")
        </button>

        @if (!string.IsNullOrEmpty(serverError))
        {
            <div class="validation-error">@serverError</div>
        }
        @if (!string.IsNullOrEmpty(serverInfo))
        {
            <div class="validation-info">@serverInfo</div>
        }
    </div>
</EditForm>

@code {
    private bool isBusy;
    private string? serverError;
    private string? serverInfo;

    // View model su DataAnnotations validacija (telefonas privalomas; el. paštas su @ ir galiojančiu TLD)
    private RegisterVm model = new();

    // OnValidSubmit kviečiamas tik jei visi laukai praeina validaciją
    private async Task HandleRegister()
    {
        serverError = null;
        serverInfo = null;

        try
        {
            isBusy = true;
            serverInfo = "Siunčiama registracija į duomenų bazę...";

            var result = await RegistrationService.RegisterAsync(new RegisterDto
            {
                Vardas = model.Vardas.Trim(),
                Pavarde = model.Pavarde.Trim(),
                AsmensKodas = model.AsmensKodas,
                Telefonas = model.Telefonas.Trim(),
                ElPastas = model.ElPastas.Trim(),
                SlaptazodisPlain = model.Slaptazodis,
                Role = "User",
                PaskyrosBusena = "Aktyvi",
                FkTeisesTeisId = 1
            });

            if (!result.Success)
            {
                serverError = result.Error ?? "Įvyko klaida registruojant.";
                return;
            }

            serverInfo = "Registracija sėkminga. Vyksta prisijungimas...";
            await AuthProvider.SignIn(model.ElPastas, "User");
            Nav.NavigateTo("/");

        }
        catch (Exception ex)
        {
            serverError = $"Klaida: {ex.Message}";
            Console.Error.WriteLine(ex);
        }
        finally
        {
            isBusy = false;
            StateHasChanged();
        }
    }

    // Vidinis VM su DataAnnotations
    private class RegisterVm
    {
        [Required(ErrorMessage = "Vardas privalomas.")]
        public string Vardas { get; set; } = string.Empty;

        [Required(ErrorMessage = "Pavardė privaloma.")]
        public string Pavarde { get; set; } = string.Empty;

        [Range(1, int.MaxValue, ErrorMessage = "Asmens kodas privalomas ir turi būti teigiamas skaičius.")]
        public int AsmensKodas { get; set; }

        [Required(ErrorMessage = "Telefonas privalomas.")]
        public string Telefonas { get; set; } = string.Empty;

        [Required(ErrorMessage = "El. paštas privalomas.")]
        [RegularExpression(@"^[^\s@]+@[^\s@]+\.[A-Za-z]{2,}$", ErrorMessage = "Neteisingas el. pašto formatas.")]
        public string ElPastas { get; set; } = string.Empty;

        [Required(ErrorMessage = "Slaptažodis privalomas.")]
        public string Slaptazodis { get; set; } = string.Empty;
    }
}
