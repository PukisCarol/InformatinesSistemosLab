@page "/complaints"
@rendermode InteractiveServer

@using InformacinesSistemos.Models
@using InformacinesSistemos.Services
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthStateProvider
@inject IUserService UserService
@inject IEmailService EmailService

<PageTitle>Nusiskundimai</PageTitle>

<h2>Pateikti nusiskundimą</h2>

<p>
    Nusiskundimai bus užfiksuoti sistemoje ir išsiųsti moderatoriui el. paštu.
    Laiškas bus siunčiamas iš tavo prisijungusios paskyros el. pašto.
</p>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success">@successMessage</div>
}

<div class="complaints-form">
    <label>Tema</label>
    <input @bind="tema" />

    <label>Nusiskundimo tekstas</label>
    <textarea @bind="tekstas"></textarea>

    <button @onclick="SubmitAsync" disabled="@isSending">
        @(isSending ? "Siunčiama..." : "Pateikti nusiskundimą")
    </button>
</div>

@if (submitted.Count > 0)
{
    <h3>Paskutiniai pateikti nusiskundimai (demonstracijai)</h3>
    <ul>
        @foreach (var c in submitted)
        {
            <li>
                @c.Data.ToString("yyyy-MM-dd HH:mm") – @c.Tema (@c.Statusas)
            </li>
        }
    </ul>
}

@code {
    private string tema = string.Empty;
    private string tekstas = string.Empty;

    private string? errorMessage;
    private string? successMessage;
    private bool isSending;

    private readonly List<Nusiskundimas> submitted = new();

    private async Task SubmitAsync()
    {
        errorMessage = null;
        successMessage = null;

        if (string.IsNullOrWhiteSpace(tema) || string.IsNullOrWhiteSpace(tekstas))
        {
            errorMessage = "Užpildykite temą ir nusiskundimo tekstą.";
            return;
        }

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user?.Identity == null || !user.Identity.IsAuthenticated)
        {
            errorMessage = "Nusiskundimą gali pateikti tik prisijungęs naudotojas.";
            return;
        }

        // SimpleAuthenticationStateProvider naudoja ClaimTypes.Name = el. paštas
        var email = user.Identity.Name ?? string.Empty;
        if (string.IsNullOrWhiteSpace(email))
        {
            errorMessage = "Nepavyko nustatyti naudotojo el. pašto.";
            return;
        }

        var naudotojas = await UserService.GetByEmailAsync(email);

        var fullName = naudotojas != null
            ? $"{naudotojas.Vardas} {naudotojas.Pavarde}".Trim()
            : email;

        var complaint = new Nusiskundimas
        {
            Tema = tema,
            NusiskundimoTekstas = tekstas,
            Statusas = "Naujas",
            Data = DateTime.Now,
            NaudotojasId = naudotojas?.NaudotojasId ?? 0
        };

        submitted.Add(complaint); // lokaliai, jeigu nori matyti sąrašą

        isSending = true;

        try
        {
            var subject = $"Naujas nusiskundimas: {tema}";
            var body = $@"
Gautas naujas nusiskundimas.

Naudotojas: {fullName} ({email})
Pateikta: {DateTime.Now:yyyy-MM-dd HH:mm}

Tema:
{tema}

Nusiskundimo tekstas:
{tekstas}
";

            await EmailService.SendComplaintEmailAsync(
                fromEmail: email,
                fromName: fullName,
                subject: subject,
                body: body
            );

            successMessage = "Nusiskundimas užregistruotas ir išsiųstas moderatoriui el. paštu.";
            tema = string.Empty;
            tekstas = string.Empty;
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine(ex);
            errorMessage = "Nusiskundimas užregistruotas, bet nepavyko išsiųsti el. laiško. Patikrink el. pašto nustatymus.";
        }
        finally
        {
            isSending = false;
        }
    }
}
