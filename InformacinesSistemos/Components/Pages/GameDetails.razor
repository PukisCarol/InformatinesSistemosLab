@page "/games/{Id:int}"

@using InformacinesSistemos.Models
@using Microsoft.AspNetCore.Components.Authorization

@inject InformacinesSistemos.Services.IGameService GameService
@inject InformacinesSistemos.Services.ICartService CartService
@inject InformacinesSistemos.Services.IReviewService ReviewService
@inject NavigationManager Nav

<PageTitle>Žaidimo informacija</PageTitle>

@if (showNotification)
{
    <div class="notification @notificationType">
        @notificationMessage
    </div>
}

@if (isLoading)
{
    <p>Kraunama...</p>
}
else if (game is null)
{
    <p>Žaidimas nerastas.</p>
    <button class="outline-btn" @onclick="@GoBack">Grįžti</button>
}
else
{
    <div class="game-details">
        <div class="gd-header">
            <span class="gd-type">@GetTypeLabel(game)</span>
            <span class="gd-price">@game.Kaina.ToString("0.00") €</span>
        </div>

        <h2>@game.Aprasymas</h2>

        <div class="gd-meta">
            <div><strong>Kūrėjas:</strong> @game.Kurejas</div>
            <div><strong>Išleidimo data:</strong> @game.IsleidimoData.ToString("yyyy-MM-dd")</div>
            <div><strong>Žaidėjų skaičius:</strong> @(game.Stalo?.ZaidejuSkaicius ?? game.ZaidejuSkaicius)</div>
            <div><strong>Amžiaus cenzas:</strong> @(game.Stalo?.AmziausCenzas ?? game.AmziausCenzas)+</div>
            <div><strong>Reitingas:</strong> @game.Reitingas.ToString("0.0")</div>
            <div><strong>Žanras:</strong> @game.Zanras?.Pavadinimas</div>
        </div>

        @if (game.Kompiuterinis != null)
        {
            <div class="gd-box">
                <h4>Kompiuterinio žaidimo informacija</h4>
                <p><strong>OS:</strong> @game.Kompiuterinis.OS</p>
                <p><strong>Platforma:</strong> @game.Kompiuterinis.Platforma</p>
                <p><strong>Užimama vieta diske:</strong> @game.Kompiuterinis.UzimamaVietaDiske GB</p>
                <p><strong>Sisteminiai reikalavimai:</strong> @game.Kompiuterinis.SisteminiaiReikalavimai</p>
            </div>
        }
        else if (game.Stalo != null)
        {
            <div class="gd-box">
                <h4>Stalo žaidimo informacija</h4>
                <p><strong>Dėžės dydis:</strong> @game.Stalo.Ilgis x @game.Stalo.Plotis x @game.Stalo.Aukstis cm</p>
                <p><strong>Svoris:</strong> @game.Stalo.Svoris kg</p>
                <p><strong>Trukmė:</strong> @game.Stalo.Trukme min</p>
            </div>
        }

        <h3>Atsiliepimai</h3>

        @if (reviews == null || reviews.Count == 0)
        {
            <p>Kol kas atsiliepimų nėra.</p>
        }
        else
        {
            <ul class="review-list">
                @foreach (var r in reviews)
                {
                    <li>
                        <strong>@r.Ivertinimas/5</strong> – @r.AtsiliepimoTekstas
                        <br />
                        <small>
                            @r.Data.ToShortDateString()
                            · Parašė: @r.Vardas
                        </small>
                    </li>
                }
            </ul>
        }

        <div class="gd-actions">
            <button class="outline-btn" @onclick="@GoBack">
                Grįžti
            </button>

            <AuthorizeView>
                <Authorized>
                    <button class="primary-btn" @onclick="@AddToCart">
                        Į krepšelį
                    </button>
                </Authorized>
                <NotAuthorized>
                    <button class="outline-btn"
                            @onclick="@(() => Nav.NavigateTo("/login"))">
                        Prisijunkite
                    </button>
                </NotAuthorized>
            </AuthorizeView>
        </div>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }

    private Zaidimas? game;
    private bool isLoading = true;

    private List<Atsiliepimas>? reviews;

    private bool showNotification = false;
    private string notificationMessage = "";
    private string notificationType = "success";

    protected override async Task OnParametersSetAsync()
    {
        isLoading = true;

        game = await GameService.GetByIdAsync(Id);

        if (game != null)
        {
            reviews = await ReviewService.GetForGameAsync(game.ZaidimoId);
        }

        isLoading = false;
    }

    private void AddToCart()
    {
        if (game != null)
        {
            CartService.Add(game, 1);
            ShowNotification($"„{game.Aprasymas}“ pridėtas į krepšelį!", "success");
        }
    }

    private void ShowNotification(string message, string type = "success")
    {
        notificationMessage = message;
        notificationType = type;
        showNotification = true;

        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            showNotification = false;
            InvokeAsync(StateHasChanged);
        });
    }

    private void GoBack()
    {
        Nav.NavigateTo("/games");
    }

    private static string GetTypeLabel(Zaidimas g)
        => g.Kompiuterinis != null ? "Kompiuterinis žaidimas"
         : g.Stalo != null ? "Stalo žaidimas"
         : "Žaidimas";
}