@page "/feedback/{zaidimoId:int}"
@rendermode InteractiveServer

@using InformacinesSistemos.Models
@using InformacinesSistemos.Services
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization

@inject IReviewService ReviewService
@inject IGameService GameService
@inject IUserService UserService
@inject AuthenticationStateProvider AuthProvider

<PageTitle>Atsiliepimai</PageTitle>

<h2>Pateikti atsiliepimą apie žaidimą</h2>

<div class="feedback-form">
    <label>Žaidimo pavadinimas</label>
    <InputText @bind-Value="zaidimoPavadinimas" readonly />

    <label>Įvertinimas (1–5)</label>
    <InputNumber @bind-Value="ivertinimas" Min="1" Max="5" />

    <label>Jūsų atsiliepimas</label>
    <InputTextArea @bind-Value="tekstas" rows="5" />

    <button class="primary-btn" @onclick="Submit" disabled="@IsSubmitDisabled">
        Pateikti atsiliepimą
    </button>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <p class="success-msg">@successMessage</p>
    }
</div>

@if (submitted.Any())
{
    <h3>Jūsų pateikti atsiliepimai (ši sesija)</h3>
    <ul class="feedback-list">
        @foreach (var f in submitted)
        {
            <li>
                <strong>@zaidimoPavadinimas</strong>
                <span>@f.Data.ToString("yyyy-MM-dd")</span>
                <span>@($"Įvertinimas: {f.Ivertinimas}/5")</span>
                <p>@f.AtsiliepimoTekstas</p>
            </li>
        }
    </ul>
}

@code {
    [Parameter]
    public int zaidimoId { get; set; }

    private string zaidimoPavadinimas = string.Empty;
    private int ivertinimas = 5;
    private string tekstas = string.Empty;
    private string successMessage = string.Empty;

    private readonly List<Atsiliepimas> submitted = new();

    private bool IsSubmitDisabled =>
        string.IsNullOrWhiteSpace(tekstas) ||
        ivertinimas < 1 || ivertinimas > 5;

    protected override async Task OnInitializedAsync()
    {
        // Užkraunam žaidimo pavadinimą pagal gameId
        var game = await GameService.GetByIdAsync(zaidimoId);
        zaidimoPavadinimas = game?.Aprasymas ?? "Nežinomas žaidimas";
    }

    private async Task Submit()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user?.Identity == null || !user.Identity.IsAuthenticated)
        {
            successMessage = "Norint pateikti atsiliepimą, turite prisijungti.";
            return;
        }

        var email = user.Identity.Name;
        if (string.IsNullOrWhiteSpace(email))
        {
            successMessage = "Nepavyko nustatyti naudotojo el. pašto.";
            return;
        }

        var entity = await UserService.GetByEmailAsync(email);
        if (entity == null)
        {
            successMessage = "Naudotojas nerastas duomenų bazėje.";
            return;
        }

        var newReview = new Atsiliepimas
        {
            Data = DateTime.Today,
            AtsiliepimoTekstas = tekstas,
            Ivertinimas = ivertinimas,
            ZaidimoId = zaidimoId,
            NaudotojasId = entity.NaudotojasId   // = AsmensKodas
        };

        await ReviewService.AddReviewAsync(newReview);

        submitted.Add(newReview);
        successMessage = "Atsiliepimas sėkmingai išsaugotas.";

        // išvalom tik tekstą ir reitingą
        tekstas = string.Empty;
        ivertinimas = 5;
    }
}
