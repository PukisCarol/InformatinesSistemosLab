@page "/feedback"
@rendermode InteractiveServer
@using InformacinesSistemos.Models
@inject IReviewService ReviewService

@inject InformacinesSistemos.Services.IReviewService ReviewService
@inject InformacinesSistemos.Services.SimpleAuthenticationStateProvider AuthProvider

<PageTitle>Atsiliepimai</PageTitle>

<h2>Pateikti atsiliepimą apie žaidimą</h2>

<div class="feedback-form">
    <input placeholder="Žaidimo pavadinimas"
           @bind="zaidimoPavadinimas" />

    <input type="number"
           min="1" max="5"
           @bind="ivertinimas"
           placeholder="Įvertinimas (1-5)" />

    <textarea placeholder="Jūsų atsiliepimas..."
              @bind="tekstas"></textarea>

    <button class="primary-btn" @onclick="Submit" disabled="@IsSubmitDisabled">
        Pateikti atsiliepimą
    </button>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <p class="success-msg">@successMessage</p>
    }
</div>

@if (submitted.Any())
{
    <h3>Pateikti atsiliepimai (šios sesijos metu)</h3>

    <ul class="feedback-list">
        @foreach (var f in submitted)
        {
            <li>
                <strong>@zaidimoPavadinimas</strong>
                <span>@f.Data.ToString("yyyy-MM-dd")</span>
                <span>@($"Įvertinimas: {f.Ivertinimas}/5")</span>
                <p>@f.AtsiliepimoTekstas</p>
            </li>
        }
    </ul>
}

@code {
    private string zaidimoPavadinimas = string.Empty;
    private int ivertinimas = 5;
    private string tekstas = string.Empty;
    private string successMessage = string.Empty;

    private readonly List<Atsiliepimas> submitted = new();

    private bool IsSubmitDisabled =>
        string.IsNullOrWhiteSpace(zaidimoPavadinimas) ||
        string.IsNullOrWhiteSpace(tekstas) ||
        ivertinimas < 1 || ivertinimas > 5;

    private async Task Submit()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? true)
        {
            successMessage = "Norint pateikti atsiliepimą, turite prisijungti.";
            return;
        }

        var newReview = new Atsiliepimas
        {// NEVEIKIA CIA DABA
           // Data = DateTime.Now,
           // AtsiliepimoTekstas = tekstas,
           // Ivertinimas = ivertinimas,
           // ZaidimoId = /* resolve game ID from zaidimoPavadinimas */
           // NaudotojasId = int.Parse(user.Identity.Name!) // or your logic for user ID
        };

        await ReviewService.AddReviewAsync(newReview);

        submitted.Add(newReview);
        successMessage = "Atsiliepimas sėkmingai išsaugotas.";

        tekstas = string.Empty;
        zaidimoPavadinimas = string.Empty;
        ivertinimas = 5;
    }
}
