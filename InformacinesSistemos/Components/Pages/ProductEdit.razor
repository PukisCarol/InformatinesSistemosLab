@page "/product-edit/{Id:int}"
@using InformacinesSistemos.Models
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Authorization
@using System.ComponentModel.DataAnnotations
@inject InformacinesSistemos.Services.IGameService GameService
@inject InformacinesSistemos.Services.IUserService UserService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav


<PageTitle>Redaguoti žaidimą</PageTitle>

<h2>Redaguoti žaidimą</h2>

@if (!isAuthenticated)
{
    <p>Norėdami redaguoti žaidimą, turite prisijungti.</p>
    <a href="/login" class="link-btn">Prisijungti</a>
}
else if (isLoading)
{
    <p>Kraunama...</p>
}
else if (model == null)
{
    <p>Žaidimas nerastas.</p>
    <button class="outline-btn" @onclick="GoBack">Grįžti</button>
}
else
{
    <EditForm Model="model" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="addgame-form">
            <label>
                Pavadinimas / aprašymas
                <InputText @bind-Value="model.Aprasymas" />
                <ValidationMessage For="@(() => model.Aprasymas)" />
            </label>

            <label>
                Kūrėjas
                <InputText @bind-Value="model.Kurejas" />
                <ValidationMessage For="@(() => model.Kurejas)" />
            </label>

            <label>
                Išleidimo data
                <InputDate @bind-Value="model.IsleidimoData" />
                <ValidationMessage For="@(() => model.IsleidimoData)" />
            </label>

            <label>
                Kaina (€)
                <InputNumber TValue="double?" @bind-Value="model.Kaina" />
                <ValidationMessage For="@(() => model.Kaina)" />
            </label>

            <label>
                Reitingas (1–5)
                <InputNumber TValue="double?" @bind-Value="model.Reitingas" />
                <ValidationMessage For="@(() => model.Reitingas)" />
            </label>

            <label>
                Amžiaus cenzas
                <InputNumber TValue="int?" @bind-Value="model.AmziausCenzas" />
                <ValidationMessage For="@(() => model.AmziausCenzas)" />
            </label>

            <label>
                Žaidėjų skaičius
                <InputText @bind-Value="model.ZaidejuSkaicius" />
                <ValidationMessage For="@(() => model.ZaidejuSkaicius)" />
            </label>

            <label>
                Žanras
                <select @bind="selectedGenreId">
                    <option value="">-- Pasirinkite žanrą --</option>
                    @foreach (var g in genres)
                    {
                        <option value="@g.ZanroId">@g.Pavadinimas</option>
                    }
                </select>
            </label>

            <label>
                Žaidimo tipas
                <select @bind="model.Tipas">
                    <option value="Kompiuterinis">Kompiuterinis žaidimas</option>
                    <option value="Stalo">Stalo žaidimas</option>
                </select>
            </label>

            @if (model.Tipas == "Kompiuterinis")
            {
                <div class="sub-box">
                    <h4>Kompiuterinio žaidimo duomenys</h4>
                    <label>
                        OS
                        <InputText @bind-Value="pc.OS" />
                        <ValidationMessage For="@(() => pc.OS)" />
                    </label>
                    <label>
                        Platforma
                        <InputText @bind-Value="pc.Platforma" />
                        <ValidationMessage For="@(() => pc.Platforma)" />
                    </label>
                    <label>
                        Užimama vieta diske (GB)
                        <InputNumber TValue="double?" @bind-Value="pc.UzimamaVietaDiske" />
                        <ValidationMessage For="@(() => pc.UzimamaVietaDiske)" />
                    </label>
                    <label>
                        Sisteminiai reikalavimai
                        <InputText @bind-Value="pc.SisteminiaiReikalavimai" />
                    </label>
                </div>
            }
            else if (model.Tipas == "Stalo")
            {
                <div class="sub-box">
                    <h4>Stalo žaidimo duomenys</h4>
                    <label>
                        Dėžės ilgis (cm)
                        <InputNumber TValue="int?" @bind-Value="board.Ilgis" />
                        <ValidationMessage For="@(() => board.Ilgis)" />
                    </label>
                    <label>
                        Dėžės plotis (cm)
                        <InputNumber TValue="int?" @bind-Value="board.Plotis" />
                        <ValidationMessage For="@(() => board.Plotis)" />
                    </label>
                    <label>
                        Dėžės aukštis (cm)
                        <InputNumber TValue="int?" @bind-Value="board.Aukstis" />
                        <ValidationMessage For="@(() => board.Aukstis)" />
                    </label>
                    <label>
                        Žaidimo trukmė (min)
                        <InputNumber TValue="int?" @bind-Value="board.Trukme" />
                        <ValidationMessage For="@(() => board.Trukme)" />
                    </label>
                    <label>
                        Svoris (kg)
                        <InputNumber TValue="double?" @bind-Value="board.Svoris" />
                        <ValidationMessage For="@(() => board.Svoris)" />
                    </label>
                </div>
            }

            <div class="form-actions">
                <button type="button" class="outline-btn" @onclick="GoBack">Atšaukti</button>
                <button type="submit" class="primary-btn">Išsaugoti</button>
            </div>
        </div>
    </EditForm>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <p class="success-msg">@successMessage</p>
    }
}

@code {
    [Parameter] public int Id { get; set; }

    private bool isAuthenticated;
    private string? currentUserEmail;
    private bool isLoading = true;

    private GameFormModel? model;
    private PcFormModel pc = new();
    private BoardFormModel board = new();
    private string? successMessage;
    private List<Zanras> genres = new();
    private int selectedGenreId;
    private bool isModeratorOrAdmin = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isAuthenticated = user.Identity?.IsAuthenticated ?? false;
        currentUserEmail = user.Identity?.Name;

        // Check if moderator or admin
        isModeratorOrAdmin = user.IsInRole("Moderator") || user.IsInRole("Admin");

        genres = await GameService.GetAllGenresAsync();

        if (isAuthenticated)
        {
            var existingGame = await GameService.GetByIdAsync(Id);
            if (existingGame != null)
            {
                model = new GameFormModel
                {
                    Aprasymas = existingGame.Aprasymas,
                    Kurejas = existingGame.Kurejas,
                    IsleidimoData = existingGame.IsleidimoData,
                    Kaina = existingGame.Kaina,
                    Reitingas = existingGame.Reitingas,
                    AmziausCenzas = existingGame.AmziausCenzas,
                    ZaidejuSkaicius = existingGame.ZaidejuSkaicius,
                    Tipas = existingGame.Kompiuterinis != null ? "Kompiuterinis" : "Stalo"
                };

                if (existingGame.Kompiuterinis != null)
                {
                    pc = new PcFormModel
                    {
                        OS = existingGame.Kompiuterinis.OS,
                        Platforma = existingGame.Kompiuterinis.Platforma,
                        UzimamaVietaDiske = existingGame.Kompiuterinis.UzimamaVietaDiske,
                        SisteminiaiReikalavimai = existingGame.Kompiuterinis.SisteminiaiReikalavimai
                    };
                }
                else if (existingGame.Stalo != null)
                {
                    board = new BoardFormModel
                    {
                        Ilgis = (int?)existingGame.Stalo.Ilgis,
                        Plotis = (int?)existingGame.Stalo.Plotis,
                        Aukstis = (int?)existingGame.Stalo.Aukstis,
                        Trukme = existingGame.Stalo.Trukme,
                        Svoris = existingGame.Stalo.Svoris
                    };
                }

                selectedGenreId = existingGame.ZanroId;
            }
            isLoading = false;
        }
    }

    private async Task HandleValidSubmit()
    {
        if (!isAuthenticated || string.IsNullOrWhiteSpace(currentUserEmail) || model == null)
            return;

        var loggedInUser = await UserService.GetByEmailAsync(currentUserEmail);
        if (loggedInUser == null)
        {
            successMessage = "Nepavyko rasti prisijungusio naudotojo duomenų.";
            return;
        }

        var game = await GameService.GetByIdAsync(Id);
        if (game == null)
        {
            successMessage = "Žaidimas nerastas.";
            return;
        }

        game.Aprasymas = model.Aprasymas;
        game.Kurejas = model.Kurejas;
        game.IsleidimoData = model.IsleidimoData;
        game.Kaina = model.Kaina ?? 0;
        game.Reitingas = model.Reitingas ?? 0;
        game.AmziausCenzas = model.AmziausCenzas ?? 0;
        game.ZaidejuSkaicius = model.ZaidejuSkaicius;
        game.ZanroId = selectedGenreId;

        if (model.Tipas == "Kompiuterinis")
        {
            game.Kompiuterinis ??= new KompiuterinisZaidimas();
            game.Kompiuterinis.OS = pc.OS;
            game.Kompiuterinis.Platforma = pc.Platforma;
            game.Kompiuterinis.UzimamaVietaDiske = pc.UzimamaVietaDiske ?? 0;
            game.Kompiuterinis.SisteminiaiReikalavimai = pc.SisteminiaiReikalavimai;
            game.Stalo = null;
        }
        else if (model.Tipas == "Stalo")
        {
            game.Stalo ??= new StaloZaidimas();
            game.Stalo.Ilgis = board.Ilgis ?? 0;
            game.Stalo.Plotis = board.Plotis ?? 0;
            game.Stalo.Aukstis = board.Aukstis ?? 0;
            game.Stalo.Trukme = board.Trukme ?? 0;
            game.Stalo.Svoris = board.Svoris ?? 0;
            game.Kompiuterinis = null;
        }

        try
        {
            await GameService.UpdateAsync(game); // Make sure you have UpdateAsync in your service
            successMessage = "Žaidimas sėkmingai atnaujintas.";
            // Navigate based on role
            if (isModeratorOrAdmin)
                Nav.NavigateTo("/moderation/games");
            else
                Nav.NavigateTo("/mygames");
        }
        catch (Exception ex)
        {
            successMessage = $"Klaida atnaujinant žaidimą: {ex.Message}";
        }
    }

    private void GoBack()
    {
        if (isModeratorOrAdmin)
            Nav.NavigateTo("/moderation/games"); // Or /admin/games if you prefer
        else
            Nav.NavigateTo("/mygames");
    }
    private class GameFormModel
    {
        [Required(ErrorMessage = "Pavadinimas yra privalomas.")]
        [StringLength(200, ErrorMessage = "Pavadinimas negali būti ilgesnis nei 200 simbolių.")]
        public string Aprasymas { get; set; } = string.Empty;

        [Required(ErrorMessage = "Kūrėjas yra privalomas.")]
        public string Kurejas { get; set; } = string.Empty;

        [Required(ErrorMessage = "Išleidimo data yra privaloma.")]
        public DateTime IsleidimoData { get; set; } = DateTime.Now;

        [Required(ErrorMessage = "Kaina yra privaloma.")]
        [Range(0.1, 9999, ErrorMessage = "Kaina turi būti didesnė nei 0.")]
        public double? Kaina { get; set; }

        [Required(ErrorMessage = "Reitingas yra privalomas.")]
        [Range(1, 5, ErrorMessage = "Reitingas turi būti tarp 1 ir 5.")]
        public double? Reitingas { get; set; } = 5;

        [Required(ErrorMessage = "Amžiaus cenzas yra privalomas.")]
        public int? AmziausCenzas { get; set; }

        [Required(ErrorMessage = "Žaidėjų skaičius yra privalomas.")]
        public string ZaidejuSkaicius { get; set; } = string.Empty;

        [Required(ErrorMessage = "Žaidimo tipas yra privalomas.")]
        public string Tipas { get; set; } = "Kompiuterinis";
    }

    private class PcFormModel
    {
        [Required(ErrorMessage = "OS yra privaloma.")]
        public string OS { get; set; } = string.Empty;

        [Required(ErrorMessage = "Platforma yra privaloma.")]
        public string Platforma { get; set; } = string.Empty;

        [Required(ErrorMessage = "Užimama vieta diske yra privaloma.")]
        [Range(0.1, 5000, ErrorMessage = "Vieta diske turi būti > 0.")]
        public double? UzimamaVietaDiske { get; set; }

        public string SisteminiaiReikalavimai { get; set; } = string.Empty;
    }

    private class BoardFormModel
    {
        [Required(ErrorMessage = "Ilgis yra privalomas.")]
        public int? Ilgis { get; set; }

        [Required(ErrorMessage = "Plotis yra privalomas.")]
        public int? Plotis { get; set; }

        [Required(ErrorMessage = "Aukštis yra privalomas.")]
        public int? Aukstis { get; set; }

        [Required(ErrorMessage = "Trukmė yra privaloma.")]
        public int? Trukme { get; set; }

        [Required(ErrorMessage = "Svoris yra privalomas.")]
        [Range(0.1, 200, ErrorMessage = "Svoris turi būti > 0.")]
        public double? Svoris { get; set; }
    }
}